import { Table } from 'react-bootstrap'
import FormContainer from '@layouts/FormContainer'
import TabContainer from '@layouts/TabContainer'
import TableContainer from '@layouts/TableContainer'
import SearchBox from '@components/SearchBox'
import ContextMenu from '@components/ContextMenu'
import { DeleteModal, InfoModal } from '@components/Modals'
import { CollectionNames, CollectionNumbers, FormStates } from '@utils/types'
import { GetByQuery, GetMany, GetOne } from '@utils/api'
import Strings from '@res/strings'
import getCol from '@utils/getCol'
import { TableHead, TableRow } from '@components/TableComponents'


private rowIndex: number

	private fetchData = () => {
		GetMany(20, this.state.collection, 1).then((data) => this.setState({ rows: data }))
	}

	constructor(props: Props) {
		super(props)

		document.title = Strings.documentTitle + ': ' + Strings[this.props.name]

		this.state = {
			rows: [],
			isSearching: false,
			currentRowId: '',
			scrollShadow: false,
			collection: getCol(this.props.name) as CollectionNumbers,
			formState: 0,
		}

		this.fetchData()

		this.tableContainer = React.createRef()

		this.searchBox = React.createRef()

		this.rowIndex = 1
	}

	private onScroll = () => {
		var el = this.tableContainer.current!
		el?.scrollTop ? this.setState({ scrollShadow: true }) : this.setState({ scrollShadow: false })
		if (el?.scrollTop + el?.clientHeight >= el?.scrollHeight - 1 && !this.state.isSearching) {
			GetMany(20, this.state.collection, this.state.rows.length + 1).then((data) => {
				data.forEach((item) => {
					this.state.rows.push(item)
					this.setState({ scrollShadow: true })
				})
			})
		}
	}

	private search = () => {
		if (this.searchBox.current?.value) {
			GetByQuery(this.searchBox.current?.value, this.state.collection, (data: any[]) =>
				this.setState({ rows: data, isSearching: true })
			)
		} else {
			this.fetchData()
			this.setState({ isSearching: false })
		}
	}

	/* private editDoc = () => {
		this.setState({ formState: 2 })
		var doc: any
		GetOne(this.state.editID, this.state.collection).then((res) => {
			doc = res[0]!
			for (var key in doc) {
				var input = document.querySelector('form[data-col="3"] input[name=' + key + ']') as HTMLInputElement
				if (doc.hasOwnProperty(key) && input) {
					console.log(input)
					input.value = doc[key]
				}
			}
		})
	} */

	componentDidUpdate() {
		this.rowIndex = 1
	}

	render() {
		return (
			<TabContainer onClick={() => this.props.onOutsideClick()}>
				<FormContainer
					col={this.state.collection}
					onResult={this.fetchData}
					formState={this.state.formState}
					switchFormState={(state: 0 | 1 | 2) => this.setState({ formState: state })}
				>
					{/* {this.state.formState == 2 && <input type="hidden" value={this.state.editID} />} */}
					{this.props.formInputs}
				</FormContainer>
				<TableContainer onScroll={this.onScroll} ref={this.tableContainer}>
					<SearchBox onInput={this.search} ref={this.searchBox} />
					<Table striped bordered hover>
						<TableHead scrollShadow={this.state.scrollShadow}>{this.props.tableHead}</TableHead>
						<tbody>
							{this.state.rows.map((row, key) => (
								<TableRow
									type={this.state.collection}
									doc={row}
									key={key}
									row={this.rowIndex++}
									id={this.state.currentRowId != '' ? this.state.currentRowId : row._id}
									onContextMenu={(e: React.MouseEvent) =>
										this.props.onRowContextMenu(e, this.state.currentRowId != '' ? this.state.currentRowId : row._id)
									}
									onClick={() => {
										var id = this.state.currentRowId != '' ? this.state.currentRowId : row._id
										this.props.onRowClick(id)
									}}
								/>
							))}
						</tbody>
					</Table>
				</TableContainer>
				<InfoModal
					reference="bookInfo"
					delete={() => this.show('deleteModal', true)}
					edit={() => {}}
					id={this.state.selectedID}
					col={this.state.collection}
				/>
				<ContextMenu event={undefined} delete={} edit={undefined} />
				<DeleteModal col={this.state.collection} id={this.state.selectedID} />
				{this.props.children}
			</TabContainer>
		)
	}